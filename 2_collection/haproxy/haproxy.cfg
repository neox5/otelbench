# ============================================================================
# HAProxy Configuration for OTLP Load Balancing
# ============================================================================
# Load balances OTLP traffic (gRPC and HTTP) across multiple otelcol-gateway
# instances for failover testing and high availability simulation.
# ============================================================================

global
    # Log to stdout for container visibility
    log stdout format raw local0 info

defaults
    # TCP mode for OTLP gRPC, overridden for HTTP frontend
    mode tcp
    
    # Connection timeouts
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    
    # Enable logging
    log global

# ============================================================================
# OTLP gRPC Frontend (port 4317)
# ============================================================================
frontend otlp_grpc
    bind *:4317
    mode tcp
    default_backend gateways_grpc

# ============================================================================
# OTLP HTTP Frontend (port 4318)
# ============================================================================
# frontend otlp_http
#     bind *:4318
#     mode http
#     timeout http-request 10s
#     default_backend gateways_http

# ============================================================================
# Gateway Backends - gRPC
# ============================================================================
backend gateways_grpc
    mode tcp
    balance roundrobin
    
    # Health check parameters:
    # - inter 2s: check every 2 seconds
    # - fall 3: mark DOWN after 3 failed checks (6s detection)
    # - rise 2: mark UP after 2 successful checks (4s recovery)
    server gateway1 otelcol-gateway-1:4317 check inter 2s fall 3 rise 2
    server gateway2 otelcol-gateway-2:4317 check inter 2s fall 3 rise 2

# ============================================================================
# Gateway Backends - HTTP
# ============================================================================
# backend gateways_http
#     mode http
#     balance roundrobin
    
#     # Health check parameters (same as gRPC backend)
#     server gateway1 otelcol-gateway-1:4318 check inter 2s fall 3 rise 2
#     server gateway2 otelcol-gateway-2:4318 check inter 2s fall 3 rise 2

# ============================================================================
# Stats Dashboard (port 8404)
# ============================================================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
