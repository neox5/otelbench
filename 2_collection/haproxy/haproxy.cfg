# ============================================================================
# HAProxy Configuration for OTLP Load Balancing
# ============================================================================

global
    log stdout format raw local0 info

defaults
    mode tcp
    
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    timeout check 10s        # ADD: Explicit check timeout (must be > inter)
    
    log global

# ============================================================================
# OTLP gRPC Frontend (port 4317)
# ============================================================================
frontend otlp_grpc
    bind *:4317
    mode tcp
    default_backend gateways_grpc

# ============================================================================
# Gateway Backends - gRPC
# ============================================================================
backend gateways_grpc
    mode tcp
    balance roundrobin
    
    option redispatch 1
    retries 3
    
    # ADD: Enable detailed health check logging
    option log-health-checks
    
    # ADD: Explicit TCP health check behavior
    option tcp-check
    tcp-check connect port 4317
    
    # Health check with proper timeout handling
    # - inter 2s: Check every 2 seconds
    # - timeout check 10s: Allow 10s for check to complete
    # - fall 3: Mark DOWN after 3 failures (6s)
    # - rise 2: Mark UP after 2 successes (4s)
    # - init-addr last,libc,none: Resolve using last known IP, then libc, then fail gracefully
    default-server inter 5s fall 3 rise 2 init-addr last,libc,none
    
    server gateway1 otelcol-gateway-1:4317 check
    server gateway2 otelcol-gateway-2:4317 check

# ============================================================================
# Stats Dashboard (port 8404)
# ============================================================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
