# ============================================================================
# OpenTelemetry Collector Configuration
# ============================================================================
# Pipeline: otelbox → OTLP receiver → transform → deltatocumulative →
#           prometheusremotewrite exporter → VictoriaMetrics
# Container Stats: podman_stats receiver → VictoriaMetrics
# ============================================================================

receivers:
  # OTLP receiver for metrics from otelbox
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Podman stats receiver for container metrics
  podman_stats:
    endpoint: "unix:///run/podman/podman.sock"
    collection_interval: 5s
    timeout: 5s

processors:
  # Transform gauge metric to delta sum
  transform/gauge_to_sum:
    error_mode: ignore
    metric_statements:
      - context: metric
        statements:
          # Convert gauge to delta sum for the rate metric
          - convert_gauge_to_sum("delta", true) where name == "ibmmq.queue.mqput.rate"

  # Rename transformed metric
  transform/rename:
    error_mode: ignore
    metric_statements:
      - context: metric
        statements:
          # Rename to indicate it's accumulated
          - set(name, "ibmmq.queue.mqput.rate.accumulated") where name == "ibmmq.queue.mqput.rate"

  # Accumulate delta values to cumulative counter
  deltatocumulative:
    max_stale: 5m
    max_streams: 1000

  # Batch processor for efficiency
  batch:
    timeout: 1s
    send_batch_size: 1000

exporters:
  # Export to VictoriaMetrics via Prometheus Remote Write
  prometheusremotewrite:
    endpoint: http://victoriametrics:8428/api/v1/write
    tls:
      insecure: true
    resource_to_telemetry_conversion:
      enabled: true

  # Debug exporter for troubleshooting (optional)
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    # Application metrics pipeline (otelbox)
    metrics:
      receivers: [otlp]
      processors:
        [transform/gauge_to_sum, transform/rename, deltatocumulative, batch]
      exporters: [prometheusremotewrite]

    # Container metrics pipeline (podman stats)
    metrics/container:
      receivers: [podman_stats]
      processors: [batch]
      exporters: [prometheusremotewrite]

  # Enable telemetry for collector itself
  telemetry:
    logs:
      level: info
      processors:
        - batch:
            exporter:
              otlp:
                protocol: http/protobuf
                endpoint: http://loki:3100/otlp/v1/logs

    metrics:
      level: detailed
      readers:
        - periodic:
            interval: 5
            exporter:
              otlp:
                protocol: http/protobuf
                endpoint: http://victoriametrics:8428/opentelemetry/v1/metrics

    resource:
      service.name: otel-collector
      service.version: 0.1.0
      deployment.environment: development
