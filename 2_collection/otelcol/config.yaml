# ============================================================================
# OpenTelemetry Collector Configuration
# ============================================================================
# Pipeline: otelbox → OTLP receiver → rename → gauge_to_sum →
#           deltatocumulative → otelcol-gateway
# ============================================================================

receivers:
  # OTLP receiver for metrics from otelbox
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317

processors:
  # Rename metrics to final naming convention
  transform/rename:
    error_mode: ignore
    metric_statements:
      - context: metric
        statements:
          # Rename mqput_mqput1 to mqput (remove redundant _mqput1)
          - replace_pattern(name, "mqput_mqput1", "mqput") where name == "ibmmq.queue.mqput_mqput1_count"

  # Convert gauge metrics to delta sum (no-op if already sum)
  transform/gauge_to_sum:
    error_mode: ignore
    metric_statements:
      - context: metric
        statements:
          # Convert gauge to delta sum for mqput count metric
          - convert_gauge_to_sum("delta", true) where name == "ibmmq.queue.mqput_count"
          # Convert gauge to delta sum for mqget count metric
          - convert_gauge_to_sum("delta", true) where name == "ibmmq.queue.mqget_count"

  # Accumulate delta values to cumulative counter
  deltatocumulative:
    max_stale: 5m
    max_streams: 10000

exporters:
  # Export to gateway via OTLP
  # Queue protects against gateway failures (HA cluster, F5 routing, network issues)
  otlp:
    endpoint: haproxy:4317
    tls:
      insecure: true

    # gRPC keepalive for connection health monitoring
    # PING cycle: 30s interval, 10s timeout = ~40s to detect dead connection
    # Coordinates with HAProxy timeouts (client/server: 60s > 30s keepalive)
    keepalive:
      time: 30s # Send PING every 30 seconds
      timeout: 10s # Wait 10s for PONG response
      permit_without_stream: true # PING even when no active RPCs

    # Request timeout (per export attempt)
    timeout: 10s

    # Persistent queue for resilience
    sending_queue:
      enabled: true
      queue_size: 5000 # Buffer for gateway unavailability
      num_consumers: 2 # Parallel senders

    # Retry on transient failures
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 1m

  # Debug exporter for troubleshooting (optional)
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    # Application metrics pipeline (otelbox)
    metrics:
      receivers: [otlp]
      processors: [transform/rename, transform/gauge_to_sum, deltatocumulative]
      exporters: [otlp]

  # Enable telemetry for collector itself
  telemetry:
    logs:
      level: info

    metrics:
      level: detailed
      readers:
        - periodic:
            interval: 5000
            exporter:
              otlp:
                protocol: grpc
                endpoint: http://localhost:4317

    resource:
      service.name: otelcol
      service.version: 0.1.0
      deployment.environment: development
