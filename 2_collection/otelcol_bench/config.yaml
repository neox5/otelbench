# ============================================================================
# OpenTelemetry Collector Bench Configuration
# ============================================================================
# Pipeline: podman_stats → batch → prometheusremotewrite
# Monitors testbench infrastructure (containers)
# ============================================================================

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317

  # Podman stats receiver for container metrics
  podman_stats:
    endpoint: "unix:///run/podman/podman.sock"
    collection_interval: 5s
    timeout: 5s

processors:
  # Batch processor for efficiency
  batch:
    timeout: 5s
    send_batch_size: 2000
    send_batch_max_size: 3000

exporters:
  # Export to VictoriaMetrics via Prometheus Remote Write
  prometheusremotewrite:
    endpoint: http://victoriametrics:8428/api/v1/write
    tls:
      insecure: true
    resource_to_telemetry_conversion:
      enabled: true

    # Remote write queue configuration
    remote_write_queue:
      enabled: true
      queue_size: 10000
      num_consumers: 2

    # Timeout and retry settings
    timeout: 30s
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 5m

  # Debug exporter for troubleshooting (optional)
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    # Container metrics pipeline (podman stats)
    metrics/container:
      receivers: [otlp, podman_stats]
      processors: [batch]
      exporters: [prometheusremotewrite]

  # Enable telemetry for collector itself
  telemetry:
    logs:
      level: info

    metrics:
      level: detailed
      readers:
        - periodic:
            interval: 5000
            exporter:
              otlp:
                protocol: grpc
                endpoint: http://localhost:4317

    resource:
      service.name: otelcol-bench
      service.version: 0.1.0
      deployment.environment: development
